---

- name: Stop applications
  ansible.builtin.systemd:
    name: '{{ service_name }}'
    state: stopped
  loop:
    - 'nginx.service'
    - 'php{{ php.version }}-fpm'
  loop_control:
    loop_var: service_name
  ignore_errors: true
  register: ignore_errors_register

- name: Restore database Nextcloud
  ansible.builtin.include_role:
    name: pg_restore_database
  vars:
    pg_restore_database_pg_filename: 'nextcloud-last.dmp'
    pg_restore_database_pg_username: '{{ dbschema.nextcloud.username }}'
    pg_restore_database_pg_database: '{{ dbschema.nextcloud.database }}'

- name: Mise Ã  jour de l'environnement occ
  ansible.builtin.shell:
    cmd: 'sudo -u nobody php{{ php.version }} occ upgrade'
    chdir: '/opt/nextcloud'

- name: Disable TOTP for users
  ansible.builtin.shell:
    cmd: 'sudo -u nobody php{{ php.version }} occ twofactorauth:disable {{ item }} totp'
    chdir: '/opt/nextcloud'
  loop:
    - 'administrator'
    - 'rickou_412'

- name: Restore files from pcloud Nextcloud
  ansible.builtin.include_role:
    name: pcloud_restore_file
  vars:
    pcloud_restore_file_foldername: '/data/nextcloud'
    pcloud_restore_file_filename: 'nextcloud-last-data.tar'

- name: Uncompress data Nextcloud
  ansible.builtin.unarchive:
    src: '/data/nextcloud/nextcloud-last-data.tar'
    dest: '/'
    remote_src: 'yes'
    owner: nobody
    group: nogroup

- name: Remove old archive Nextcloud
  ansible.builtin.file:
    path: '/data/nextcloud/nextcloud-last-data.tar'
    state: 'absent'

- name: Restart applications
  ansible.builtin.systemd:
    name: '{{ service_name }}'
    state: started
  loop:
    - 'php{{ php.version }}-fpm'
    - 'nginx.service'
  loop_control:
    loop_var: service_name
